!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("loc",[],t):"object"==typeof exports?exports.loc=t():e.loc=t()}(window,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=3)}([function(e,t,o){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=function(e){var t,o;return o=t=function(t){function o(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),a(e=r(this,(o.__proto__||Object.getPrototypeOf(o)).call(this)),"geo_success",function(t){var o=t.coords,n={isOutdoor:1,longitude:o.longitude,latitude:o.latitude,accuracy:o.accuracy,level:"0",locType:"gps",timestamp:t.timestamp};e.onSuccessGps(n)}),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(o,e),function(e,t,o){t&&i(e.prototype,t),o&&i(e,o)}(o,[{key:"checkGPS",value:function(){"geolocation"in navigator&&(this.initGps=!0,this.initSuccess())}},{key:"startGpsSearch",value:function(){console.log("进入gps"),this.startSuccess({code:1,msg:"gps定位启动"}),o.gpsWatchId=navigator.geolocation.watchPosition(this.geo_success,o.geo_error,{enableHighAccuracy:!0,timeout:this.timeout})}},{key:"stopGpsSearch",value:function(){console.log("停止gps"),navigator.geolocation.clearWatch(o.gpsWatchId),this.stopLocationComplete({code:1,msg:"gps定位停止"})}}],[{key:"geo_error",value:function(e){throw e}}]),o}(),a(t,"gpsWatchId",null),o};t.default=s,e.exports=t.default},function(e,t,o){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){r(e,t,o[t])})}return e}function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var u=function(e){var t="ios",o=[],n=null,r=navigator.userAgent.toLowerCase();return/iphone|ipad|ipod/.test(r)?t="ios":/android/.test(r)&&(t="android"),function(r){function u(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),a(this,(u.__proto__||Object.getPrototypeOf(u)).call(this))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(u,e),function(e,t,o){t&&c(e.prototype,t),o&&c(e,o)}(u,[{key:"getSignature",value:function(){var e=this,t="url=".concat(encodeURIComponent(window.location.href.split("#")[0]),"&mapId=").concat(this.mapId);window.onunload=function(){e.wx.stopSearchBeacons()};var o="".concat(this.requestUrl,"/wxConfig/weixin/v1/jsSdkSign");fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t}).then(function(e){return e.json()}).then(function(t){e.configWx(t.data),e.initIbeacon=!0,e.initSuccess()}).catch(function(t){e.initError(t)})}},{key:"configWx",value:function(e){var t=this;this.wx.config({debug:!1,appId:e.appid,timestamp:e.timestamp,nonceStr:e.nonceStr,signature:e.signature,beta:!0,jsApiList:["openWXDeviceLib","closeWXDeviceLib","onWXDeviceBluetoothStateChange","startSearchBeacons","stopSearchBeacons","onSearchBeacons","startRecord","stopRecord","translateVoice","onMenuShareAppMessage","getLocation","openBluetoothAdapter","onBeaconServiceChange","onWXDeviceBluetoothStateChange","getBluetoothAdapterState","onBluetoothAdapterStateChange"]}),this.wx.error(function(e){t.initError(e)})}},{key:"stopIbeaconSearch",value:function(){var e=this;this.wx.stopSearchBeacons({complete:function(){console.log("停止蓝牙"),e.stopLocationComplete({code:0,msg:"蓝牙停止"})}})}},{key:"startIbeaconSearch",value:function(){var e=this;console.log("进入蓝牙"),this.wx.ready(function(){var t=0,n=!1,i=void 0;window.addEventListener("devicemotion",function(){Date.now()-t>=300&&(t=Date.now(),!1===n&&e.wx.stopSearchBeacons({complete:function(){console.log("启动蓝牙搜索"),o=[],e.searchIbeacon()},fail:function(e){console.log("stop fail",e)}}),n=!0,i&&clearTimeout(i),i=setTimeout(function(){n=!1,e.wx.stopSearchBeacons()},500))}),e.initGps,e.onSearchBeaconsWithGps()})}},{key:"searchIbeacon",value:function(){var e=this;this.wx.startSearchBeacons({ticket:"",complete:function(t){e.startSuccess({code:0,msg:"室内定位启动，".concat(t.errMsg)});var o=t.errMsg;if("startSearchBeacons:already started"===o)return e.wx.stopSearchBeacons(function(){e.searchIbeacon()});"startSearchBeacons:system unsupported"===o&&e.searchIbeacon(),"startSearchBeacons:bluetooth power off"===o?e.startLocationError("蓝牙未打开"):"startSearchBeacons:location service disable"===o&&e.startLocationError("地理位置服务未打开")},fail:function(e){console.log("sdk-开启失败",e)}})}},{key:"onSearchBeacons",value:function(){var e=this;this.wx.onSearchBeacons({complete:function(t){e.getIbeaconPoints(t)}})}},{key:"onSearchBeaconsWithGps",value:function(){var e=this;console.log("进入蓝牙定时搜索"),this.wx.onSearchBeacons({complete:function(t){t.beacons=t.beacons&&t.beacons.filter(function(e){return 0!=e.rssi&&e.rssi>-90}),t.beacons&&t.beacons.length>0&&(e.currentLocation="ibeacon",e.getIbeaconPoints(t),n&&clearTimeout(n),n=setTimeout(function(){console.log("定时器执行"),o=[],e.currentLocation="gps"},5e3))},fail:function(e){console.log("蓝牙扫描失败",e)}})}},{key:"getIbeaconPoints",value:function(e){var o=this,n=e.beacons&&e.beacons.map(function(e){return{rssi:~~Number(e.rssi),device:"".concat(e.major,"_").concat(e.minor)}});if(0===n.length);else{n=JSON.stringify([n]);var r="mapId=".concat(this.mapId,"&datajson=").concat(n,"\n            &interval=").concat(500,"&type=wx_").concat(t),c="".concat(this.requestUrl,"/location/weka/v1/classify");fetch(c,{method:"PUT",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}).then(function(e){return e.json()}).then(function(e){if(0==e.code){var t=e.data,n=o.setPolygonLocation(t),r=i({isOutdoor:0,longitude:t.lon,latitude:t.lat,buildingId:t.building,level:t.level,fiducialLat:t.fiducialLat,fiducialLon:t.fiducialLon,locType:"ibeacon",timer:(new Date).getTime()},n);o.onSuccessIbeacon(r)}}).catch(function(e){console.log("失败",e)})}}},{key:"setPolygonLocation",value:function(e){if(o.length<3)return o.push(e),{polygonLon:0,polygonLat:0};o.push(e);var t=o&&o.map(function(e,t){return i({},e,{timestamp:(new Date).getTime()+2e3*t})}),n=this.polygonV2(t);return o.shift(),n}},{key:"polygonV2",value:function(e){for(var t=0,o=0,n=0,i=0;i<e.length;i++)t+=e[i].timestamp,o+=e[i].lon*e[i].timestamp,n+=e[i].lat*e[i].timestamp;return{polygonLon:o/t,polygonLat:n/t}}}]),u}()};t.default=u,e.exports=t.default},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,i=r(o(1));function r(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var s=new((0,r(o(0)).default)(n=(0,i.default)(n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"initIbeacon",!1),a(this,"initGps",!1),a(this,"ibeaconCoords",null),a(this,"gpsCoords",null),a(this,"locType",[]),a(this,"currentPosition",null),a(this,"currentLocation","gps")}return function(e,t,o){t&&c(e.prototype,t),o&&c(e,o)}(e,[{key:"init",value:function(e){var t=e.timeout,o=e.locType,n=e.mapId,i=e.wxSDK,r=e.requestUrl,c=e.complete,a=void 0===c?function(){}:c,s=e.error,u=void 0===s?function(){}:s;console.log("开始定位"),this.mapId=n,this.timeout=t,this.locType=o,this.initComplete=a,this.initError=u,this.wx=i,this.requestUrl=r,o&&o.includes("ibeacon")&&this.getSignature()}},{key:"initSuccess",value:function(){this.locType.includes("ibeacon")&&this.initIbeacon&&this.initComplete()}},{key:"startLocation",value:function(e){var t=e.complete,o=void 0===t?function(){}:t,n=e.error,i=void 0===n?function(){}:n;this.startLocationComplete=o,this.startLocationError=i,this.locType&&this.locType.includes("gps")&&this.startGpsSearch(),this.locType&&this.locType.includes("ibeacon")&&this.startIbeaconSearch()}},{key:"startSuccess",value:function(e){this.startLocationComplete(e)}},{key:"stopLocation",value:function(e){var t=e.complete,o=void 0===t?function(){}:t;e.error;this.stopLocationComplete=o,this.locType&&this.locType.includes("gps")&&this.stopGpsSearch(),this.locType&&this.locType.includes("ibeacon")&&this.stopIbeaconSearch()}},{key:"onLocation",value:function(e){var t=e.complete,o=void 0===t?function(){}:t;e.error;this.onLocationComplete=o}},{key:"onSuccessGps",value:function(e){this.gpsCoords=e,"ibeacon"!==this.currentLocation&&(this.onLocationComplete(this.gpsCoords),this.currentPosition=e)}},{key:"onSuccessIbeacon",value:function(e){this.ibeaconCoords=e,this.currentPosition=e,this.onLocationComplete(this.ibeaconCoords,this)}}]),e}())||n)||n);t.default=s,e.exports=t.default},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=function(e){return e&&e.__esModule?e:{default:e}}(o(2)).default;t.default=n,e.exports=t.default}])});
//# sourceMappingURL=loc.min.js.map