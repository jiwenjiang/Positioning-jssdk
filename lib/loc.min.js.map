{"version":3,"sources":["webpack://loc/webpack/universalModuleDefinition","webpack://loc/webpack/bootstrap","webpack://loc/./src/gps/index.js","webpack://loc/./src/bluetooth/index.js","webpack://loc/./src/loc.js","webpack://loc/./src/index.js"],"names":["root","factory","exports","module","define","amd","window","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","target","_class","_temp","_target","gps","_this","_classCallCheck","this","_defineProperty","_possibleConstructorReturn","__proto__","getPrototypeOf","res","data","coords","gpsObj","isOutdoor","longitude","latitude","accuracy","level","locType","timestamp","onSuccessGps","_inherits","_createClass","navigator","initGps","initSuccess","console","log","startSuccess","code","msg","gpsWatchId","geolocation","watchPosition","geo_success","geo_error","enableHighAccuracy","timeout","clearWatch","stopLocationComplete","err","phoneType","ibeaconArr","gpsTimeId","ua","userAgent","toLowerCase","test","bluetooth","signBody","encodeURIComponent","location","href","split","concat","mapId","onunload","wx","stopSearchBeacons","signUrl","requestUrl","fetch","method","headers","Content-Type","body","then","response","json","configWx","initIbeacon","catch","initError","sign","_this2","config","debug","appId","appid","nonceStr","signature","beta","jsApiList","error","_this3","complete","_this4","ready","time","flag","timeId","addEventListener","Date","now","searchIbeacon","fail","clearTimeout","setTimeout","onSearchBeaconsWithGps","_this5","startSearchBeacons","ticket","errMsg","startLocationError","_this6","onSearchBeacons","getIbeaconPoints","_this7","beacons","filter","v","rssi","length","currentLocation","_this8","filterData","map","Number","device","major","minor","JSON","stringify","getIbeaconBody","getIbeconUrl","Polygon","setPolygonLocation","ibeaconObj","lon","lat","buildingId","building","fiducialLat","fiducialLon","timer","getTime","onSuccessIbeacon","push","polygonLon","polygonLat","inputArr","_objectSpread","polygonLocation","polygonV2","shift","points","x","y","_bluetooth","_interopRequireDefault","_ref","wxSDK","_ref$complete","_ref$error","initComplete","includes","getSignature","_ref2$complete","_ref2","_ref2$error","startLocationComplete","startGpsSearch","startIbeaconSearch","_ref3$complete","_ref3","stopGpsSearch","stopIbeaconSearch","_ref4$complete","_ref4","onLocationComplete","gpsCoords","currentPosition","ibeaconCoords"],"mappings":"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","file":"loc.min.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"loc\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"loc\"] = factory();\n\telse\n\t\troot[\"loc\"] = factory();\n})(window, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n","/**\r\n * Created by j_bleach on 2018/10/16 0016.\r\n */\r\nconst gpsFn = (target) => {\r\n    return class gps extends target {\r\n        static gpsWatchId = null;\r\n\r\n        constructor() {\r\n            super();\r\n        }\r\n\r\n        checkGPS() {\r\n            if (\"geolocation\" in navigator) {\r\n                /* 地理位置服务可用 */\r\n                this.initGps = true;\r\n                this.initSuccess();\r\n            } else {\r\n                /* 地理位置服务不可用 */\r\n            }\r\n        }\r\n\r\n        geo_success = (res) => {\r\n            const data = res.coords;\r\n            const gpsObj = {\r\n                isOutdoor: 1,\r\n                longitude: data.longitude,\r\n                latitude: data.latitude,\r\n                accuracy: data.accuracy,\r\n                level: \"0\",\r\n                locType: \"gps\",\r\n                timestamp: res.timestamp,\r\n                // timer: new Date().getTime(),\r\n            };\r\n            this.onSuccessGps(gpsObj);\r\n        };\r\n\r\n        static geo_error(err) {\r\n            throw err;\r\n        }\r\n\r\n        startGpsSearch() {\r\n            console.log(\"进入gps\");\r\n            this.startSuccess({code: 1, msg: \"gps定位启动\"});\r\n            gps.gpsWatchId = navigator.geolocation.watchPosition(this.geo_success, gps.geo_error, {\r\n                enableHighAccuracy: true,\r\n                timeout: this.timeout\r\n            });\r\n        }\r\n\r\n        stopGpsSearch() {\r\n            console.log(\"停止gps\");\r\n            navigator.geolocation.clearWatch(gps.gpsWatchId);\r\n            this.stopLocationComplete({code: 1, msg: \"gps定位停止\"});\r\n        }\r\n    };\r\n};\r\n\r\nexport default gpsFn;\r\n","/**\n * Created by j_bleach on 2018/10/16 0016.\n */\n\nconst INTERVAL = 500; // 服务器时间间隔\nconst POINTLENTH = 3; // 质心点计算数组长度\nconst CHANGE_GPS = 5000; // 搜索不到蓝牙5000ms后，切换gps\n\nconst blueToothFn = (target) => {\n  // const deviceUrl = `https://xz.parkbobo.com/location/device/v1/getAll`;\n  let phoneType = \"ios\";\n  let ibeaconArr = []; // 蓝牙地位点集合\n  let gpsTimeId = null; // gps定时器标记\n  const ua = navigator.userAgent.toLowerCase();\n  if (/iphone|ipad|ipod/.test(ua)) {\n    phoneType = `ios`;\n  } else if (/android/.test(ua)) {\n    phoneType = `android`;\n  }\n\n  return class bluetooth extends target {\n    constructor() {\n      super();\n    }\n\n    getSignature() {\n      const signBody = `url=${encodeURIComponent(window.location.href.split(\"#\")[0])}&mapId=${this.mapId}`;\n      // const deviceBody = `mapId=${this.mapId}&isElevator=1`;\n      // 注销页面，停止微信\n      window.onunload = () => {\n        this.wx.stopSearchBeacons();\n      };\n      // 请求签名\n      const signUrl = `${this.requestUrl}/wxConfig/weixin/v1/jsSdkSign`;\n      fetch(signUrl, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\"\n        },\n        body: signBody\n      }).then((response) => response.json()).then((data) => {\n\n        this.configWx(data.data);\n        this.initIbeacon = true;\n        this.initSuccess();\n      }).catch((err) => {\n        this.initError(err);\n      });\n\n      // fetch(deviceUrl, {\n      //     method: \"PUT\",\n      //     headers: {\n      //         \"Content-Type\": \"application/x-www-form-urlencoded\",\n      //     },\n      //     body: deviceBody\n      // }).then((response) => response.json()).then((data) => {\n      //     const arr = data.data;\n      //     this.elevators = arr && arr.map(v => v.device);\n      // }).catch((err) => {\n      //     this.initError(err);\n      // });\n    }\n\n    // 配置微信\n    configWx(sign) {\n      this.wx.config({\n        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\n        appId: sign.appid, // 必填，公众号的唯一标识\n        timestamp: sign.timestamp, // 必填，生成签名的时间戳\n        nonceStr: sign.nonceStr, // 必填，生成签名的随机串\n        signature: sign.signature,// 必填，签名\n        beta: true,   //用于在页面加载之初调用JSAPI\n        jsApiList: [\"openWXDeviceLib\", \"closeWXDeviceLib\",\n          \"onWXDeviceBluetoothStateChange\", \"startSearchBeacons\",\n          \"stopSearchBeacons\", \"onSearchBeacons\", \"startRecord\", \"stopRecord\",\n          \"translateVoice\", \"onMenuShareAppMessage\", \"getLocation\",\n          \"openBluetoothAdapter\", \"onBeaconServiceChange\", \"onWXDeviceBluetoothStateChange\",\n          \"getBluetoothAdapterState\", \"onBluetoothAdapterStateChange\"] // 必填，需要使用的JS接口列表\n      });\n      this.wx.error((res) => {\n        this.initError(res);\n      });\n    }\n\n    stopIbeaconSearch() {\n      this.wx.stopSearchBeacons({\n        complete: () => {\n          console.log(\"停止蓝牙\");\n          this.stopLocationComplete({code: 0, msg: \"蓝牙停止\"});\n        }\n      });\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-16\n     * @Description: 开始搜索\n     */\n    startIbeaconSearch() {\n      console.log(\"进入蓝牙\");\n      this.wx.ready(() => {\n        let time = 0;\n        let flag = false;\n        let timeId = void 0;\n        window.addEventListener(\"devicemotion\", () => {\n          if (Date.now() - time >= 300) {\n            time = Date.now();\n            if (false === flag) {\n              this.wx.stopSearchBeacons({\n                complete: () => {\n                  console.log(\"启动蓝牙搜索\");\n                  ibeaconArr = [];\n                  this.searchIbeacon();\n                },\n                fail: (err) => {\n                  console.log(\"stop fail\", err);\n                }\n              });\n            }\n            flag = true;\n            timeId && clearTimeout(timeId);\n            timeId = setTimeout(() => {\n              flag = false;\n              this.wx.stopSearchBeacons();\n            }, 500);\n          }\n        });\n\n        if (!this.initGps) {\n          this.onSearchBeaconsWithGps();\n        } else {\n          this.onSearchBeaconsWithGps();\n        }\n      });\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-16\n     * @Description: 搜索蓝牙点\n     */\n    searchIbeacon() {\n      this.wx.startSearchBeacons({\n        ticket: \"\",\n        complete: (t) => {\n          this.startSuccess({code: 0, msg: `室内定位启动，${t.errMsg}`});\n          let n = t.errMsg;\n          if (\"startSearchBeacons:already started\" === n) {\n            return this.wx.stopSearchBeacons(() => {\n              this.searchIbeacon();\n            });\n          }\n          if (\"startSearchBeacons:system unsupported\" === n) {\n            this.searchIbeacon();\n          }\n          \"startSearchBeacons:bluetooth power off\" === n\n            ? this.startLocationError(\"蓝牙未打开\")\n            : \"startSearchBeacons:location service disable\" === n && this.startLocationError(\"地理位置服务未打开\");\n        },\n        fail: (t) => {\n          console.log(\"sdk-开启失败\", t);\n        }\n      });\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-17\n     * @Description: 监听蓝牙点\n     */\n    onSearchBeacons() {\n      this.wx.onSearchBeacons({ //监听iBeacon设备更新事件\n        complete: (data) => {\n          this.getIbeaconPoints(data);\n        }\n      });\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-18\n     * @Description: 监听蓝牙点（超时切换gps）\n     */\n    onSearchBeaconsWithGps() {\n      console.log(\"进入蓝牙定时搜索\");\n      this.wx.onSearchBeacons({ //监听iBeacon设备更新事件\n        complete: (data) => {\n          data.beacons = data.beacons && data.beacons.filter(v => (v.rssi != 0 && v.rssi > -90));\n          if (data.beacons && data.beacons.length > 0) {\n            this.currentLocation = \"ibeacon\";\n            this.getIbeaconPoints(data);\n            gpsTimeId && clearTimeout(gpsTimeId);\n            gpsTimeId = setTimeout(() => {\n              console.log(\"定时器执行\");\n              ibeaconArr = [];\n              this.currentLocation = \"gps\";\n            }, CHANGE_GPS);\n          }\n        },\n        fail: (err) => {\n          console.log(\"蓝牙扫描失败\", err);\n        }\n      });\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-17\n     * @Description: 获取蓝牙点\n     */\n    getIbeaconPoints(data) {\n      let filterData = data.beacons && data.beacons\n        .map(v => {\n          return {rssi: ~~Number(v.rssi), device: `${v.major}_${v.minor}`};\n        });\n      if (filterData.length === 0) {\n        // this.onSuccess();\n      } else {\n        filterData = JSON.stringify([filterData]);\n        const getIbeaconBody = `mapId=${this.mapId}&datajson=${filterData}\n            &interval=${INTERVAL}&type=wx_${phoneType}`;\n        // console.log(\"请求\", getIbeaconBody);\n        const getIbeconUrl = `${this.requestUrl}/location/weka/v1/classify`;// map\n        fetch(getIbeconUrl, {\n          method: \"PUT\",\n          headers: {\n            \"Content-Type\": \"application/x-www-form-urlencoded\"\n          },\n          body: getIbeaconBody\n        }).then((response) => response.json()).then((data) => {\n          if (data.code == 0) {\n            const res = data.data;\n            const Polygon = this.setPolygonLocation(res);\n            const ibeaconObj = {\n              isOutdoor: 0,\n              longitude: res.lon,\n              latitude: res.lat,\n              buildingId: res.building,\n              level: res.level,\n              fiducialLat: res.fiducialLat,\n              fiducialLon: res.fiducialLon,\n              locType: \"ibeacon\",\n              timer: new Date().getTime(),\n              ...Polygon\n            };\n            this.onSuccessIbeacon(ibeaconObj);\n          }\n        }).catch((err) => {\n          // this.initError(err);\n          console.log(\"失败\", err);\n        });\n      }\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-10-17\n     * @Description: 计算质心点\n     * @param data:array\n     * @return Polygon:obj\n     */\n    setPolygonLocation(data) {\n      if (ibeaconArr.length < POINTLENTH) {\n        ibeaconArr.push(data);\n        return {\n          polygonLon: 0,\n          polygonLat: 0\n        };\n      } else {\n        ibeaconArr.push(data);\n        const inputArr = ibeaconArr && ibeaconArr.map((v, i) => {\n          return {...v, timestamp: new Date().getTime() + i * 2000};\n        });\n        const polygonLocation = this.polygonV2(inputArr);\n        ibeaconArr.shift();\n        return polygonLocation;\n      }\n    }\n\n    /**\n     * @author j_bleach\n     * @date 2018-08-23\n     * @Description: 更新质心点算法 polygonV2\n     * @param points:Array\n     */\n    polygonV2(points) {\n      let m = 0, x = 0, y = 0;\n      for (let i = 0; i < points.length; i++) {\n        m += points[i].timestamp;\n        x += (points[i].lon * points[i].timestamp);\n        y += (points[i].lat * points[i].timestamp);\n      }\n      return {polygonLon: x / m, polygonLat: y / m};\n    }\n  };\n};\n\nexport default blueToothFn;\n","/**\n * Created by j_bleach on 2018/10/16 0016.\n */\n/*eslint-disable*/\nimport bluetooth from \"./bluetooth\";\nimport gps from \"./gps\";\n\n@gps\n@bluetooth\nclass Loc {\n  /**\n   * @author j_bleach\n   * @date 2018-10-15\n   * @Description: 定位初始化\n   * @param timeout:number 超时时间，默认无穷大\n   * @param locType:string[] 定位类型\n   * @param complete:fn 成功回调\n   * @param error:fn 失败回调\n   * @return void\n   */\n  initIbeacon = false;\n  initGps = false;\n  ibeaconCoords = null;\n  gpsCoords = null;\n  locType = [];\n  currentPosition = null;\n  currentLocation = \"gps\";\n\n\n  init({\n         timeout,\n         locType,\n         mapId,\n         wxSDK,\n         requestUrl,\n         complete = () => {\n         },\n         error = () => {\n         }\n       }) {\n    console.log(\"开始定位\");\n    this.mapId = mapId;\n    this.timeout = timeout; // 超时时间\n    this.locType = locType; // 定位类型\n    this.initComplete = complete; // 初始化成功函数\n    this.initError = error; // 初始化失败函数\n    this.wx = wxSDK;\n    this.requestUrl = requestUrl;\n    // locType && locType.includes(\"gps\") && this.checkGPS();\n    locType && locType.includes(\"ibeacon\") && this.getSignature();\n  }\n\n  initSuccess() {\n    if (this.locType.includes(\"ibeacon\") && this.initIbeacon) {\n      this.initComplete();\n    }\n  }\n\n  // 开启定位\n  startLocation({\n                  complete = () => {\n                  },\n                  error = () => {\n                  }\n                }) {\n    this.startLocationComplete = complete;\n    this.startLocationError = error;\n    this.locType && this.locType.includes(\"gps\") && this.startGpsSearch();\n    this.locType && this.locType.includes(\"ibeacon\") && this.startIbeaconSearch();\n  }\n\n  // 开启成功\n  startSuccess(response) {\n    this.startLocationComplete(response);\n  }\n\n  // 停止定位\n  stopLocation(\n    {\n      complete = () => {\n      },\n      error = () => {\n      }\n    }\n  ) {\n    this.stopLocationComplete = complete;\n    this.locType && this.locType.includes(\"gps\") && this.stopGpsSearch();\n    this.locType && this.locType.includes(\"ibeacon\") && this.stopIbeaconSearch();\n  }\n\n  // 监听定位\n  onLocation(\n    {\n      complete = () => {\n      },\n      error = () => {\n      }\n    }\n  ) {\n    this.onLocationComplete = complete;\n  }\n\n  onSuccessGps(data) {\n    this.gpsCoords = data;\n    if (this.currentLocation !== \"ibeacon\") {\n      this.onLocationComplete(this.gpsCoords);\n      this.currentPosition = data;\n    }\n  }\n\n  onSuccessIbeacon(data) {\n    this.ibeaconCoords = data;\n    this.currentPosition = data;\n    this.onLocationComplete(this.ibeaconCoords, this);\n  }\n}\n\nexport default new Loc();\n","/**\r\n * Created by j_bleach on 2018/10/16 0016.\r\n */\r\nimport loc from \"./loc\";\r\n\r\nexport default loc;"],"sourceRoot":""}